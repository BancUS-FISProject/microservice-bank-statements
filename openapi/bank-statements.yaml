openapi: 3.0.3
info:
  title: Bank Statements API
  version: 1.1.0
  description: |
    API para gestionar estados de cuenta bancarios con generación automatizada.
      Características principales:
      - Generación manual del mes actual desde transacciones externas
      - Autenticación JWT
      - Validación de IBAN español

servers:
  - url: http://localhost:3000
    description: Servidor local de desarrollo
  - url: https://api.bancus.com
    description: Servidor de producción

paths:
  /health:
    get:
      summary: Health check del servicio
      tags:
        - health
      responses:
        '200':
          description: Servicio funcionando correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "internal_server_error"
                message: "Error al verificar el estado del servicio"

  /v1/bankstatements/by-iban/{iban}:
    get:
      summary: Listar meses disponibles por IBAN
      description: Obtiene la lista de meses para los cuales existen estados de cuenta para un IBAN específico
      tags:
        - bankstatements
      parameters:
        - name: iban
          in: path
          required: true
          schema:
            type: string
            pattern: '^ES[0-9]{22}$'
          description: IBAN español (ES + 22 dígitos)
      responses:
        '200':
          description: Lista de meses disponibles
          content:
            application/json:
              schema:
                type: object
                properties:
                  iban:
                    type: string
                  months:
                    type: array
                    items:
                      $ref: '#/components/schemas/MonthSummary'
        '404':
          description: No hay estados de cuenta para este IBAN
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Sin permiso para acceder a este IBAN
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: IBAN inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "invalid_iban"
                message: "El formato del IBAN es inválido"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "failed_to_get_by_iban"
                message: "Error al obtener los meses disponibles"

  /v1/bankstatements/by-iban:
    get:
      summary: Obtener statement por IBAN y mes
      description: Obtiene el estado de cuenta específico para un IBAN y mes
      tags:
        - bankstatements
      parameters:
        - name: iban
          in: query
          required: true
          schema:
            type: string
            pattern: '^ES[0-9]{22}$'
          description: IBAN español
        - name: month
          in: query
          required: true
          schema:
            type: string
            pattern: '^\d{4}-(0[1-9]|1[0-2])$'
          description: Mes en formato YYYY-MM
      responses:
        '200':
          description: Statement encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  iban:
                    type: string
                  month:
                    type: string
                  detail:
                    $ref: '#/components/schemas/BankStatement'
        '201':
          description: Statement generado automáticamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  iban:
                    type: string
                  month:
                    type: string
                  detail:
                    $ref: '#/components/schemas/BankStatement'
                  generated:
                    type: boolean
                  message:
                    type: string
        '400':
          description: Formato de mes o IBAN inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Statement no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "failed_to_get_by_iban_month"
                message: "Error al obtener el estado de cuenta"

  /v1/bankstatements/{id}:
    get:
      summary: Obtener statement por ID
      description: Obtiene un estado de cuenta específico por su ID de MongoDB
      tags:
        - bankstatements
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{24}$'
          description: ID de MongoDB (24 caracteres hexadecimales)
      responses:
        '200':
          description: Statement encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  detail:
                    $ref: '#/components/schemas/BankStatement'
        '404':
          description: Statement no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: ID inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "invalid_id"
                message: "El ID proporcionado no es válido"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "failed_to_get_by_id"
                message: "Error al obtener el estado de cuenta"
    
    delete:
      summary: Eliminar statement por ID
      description: Elimina un estado de cuenta por su ID de MongoDB
      tags:
        - bankstatements
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{24}$'
          description: ID de MongoDB
      responses:
        '200':
          description: Statement eliminado
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                    example: true
                  id:
                    type: string
        '404':
          description: Statement no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: ID inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "invalid_id"
                message: "El ID proporcionado no es válido"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "failed_to_delete"
                message: "Error al eliminar el estado de cuenta"
    
    put:
      summary: Actualizar statement por ID
      description: Actualiza un estado de cuenta existente por su ID de MongoDB. Permite actualizar transacciones y totales.
      tags:
        - bankstatements
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{24}$'
          description: ID de MongoDB del statement
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                transactions:
                  type: array
                  items:
                    $ref: '#/components/schemas/Transaction'
                total_incoming:
                  type: number
                  description: Total de dinero recibido
                total_outgoing:
                  type: number
                  description: Total de dinero enviado
            example:
              transactions:
                - date: "2026-01-15T10:30:00.000Z"
                  amount: 250.50
                  currency: "EUR"
                  description: "Transferencia recibida"
              total_incoming: 1500.50
              total_outgoing: 800.00
      responses:
        '200':
          description: Statement actualizado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Estado de cuenta actualizado exitosamente"
                  updated:
                    type: boolean
                    example: true
                  statement:
                    $ref: '#/components/schemas/BankStatement'
        '400':
          description: ID inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "invalid_id"
                message: "El ID proporcionado no es válido"
        '404':
          description: Statement no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "not_found"
                message: "Statement no encontrado"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "failed_to_update"
                message: "Error al actualizar el estado de cuenta"

  /v1/bankstatements/generate:
    post:
      summary: Generar bank statements
      description: |
        **Sin body**: Genera statements para todas las cuentas (bulk - scheduler automático).
        
        **Con body**: Genera un statement puntual con transacciones proporcionadas.
      tags:
        - bankstatements
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                accountId:
                  type: string
                  description: IBAN de la cuenta
                  example: "ES2222222222222222222222"
                month:
                  type: integer
                  minimum: 1
                  maximum: 12
                  description: Mes (1-12)
                  example: 1
                year:
                  type: integer
                  minimum: 2020
                  maximum: 2100
                  description: Año
                  example: 2026
                transactions:
                  type: array
                  description: Array de transacciones
                  items:
                    type: object
                    required:
                      - date
                      - amount
                      - currency
                    properties:
                      date:
                        type: string
                        format: date-time
                        description: Fecha de la transacción en formato ISO 8601
                        example: "2026-01-15T10:30:00.000Z"
                      amount:
                        type: number
                        description: Monto de la transacción
                        example: 250.50
                      currency:
                        type: string
                        description: Moneda de la transacción
                        example: "EUR"
                      description:
                        type: string
                        description: Descripción opcional de la transacción
                        example: "Transferencia recibida"
            examples:
              withTransactions:
                summary: Con transacciones
                value:
                  accountId: "ES2222222222222222222222"
                  month: 1
                  year: 2026
                  transactions:
                    - date: "2026-01-15T10:30:00.000Z"
                      amount: 250.50
                      currency: "EUR"
                      description: "Transferencia recibida"
                    - date: "2026-01-20T14:00:00.000Z"
                      amount: 100.00
                      currency: "EUR"
                      description: "Pago de servicios"
              bulk:
                summary: Bulk (sin body)
                value: {}
      responses:
        '201':
          description: Statement(s) generado(s) exitosamente
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      created:
                        type: boolean
                      statement:
                        $ref: '#/components/schemas/BankStatement'
                  - type: object
                    properties:
                      created:
                        type: boolean
                      statements:
                        type: array
                        items:
                          $ref: '#/components/schemas/BankStatement'
        '400':
          description: Parámetros inválidos o mes en curso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "month_in_progress"
                message: "No se puede generar el estado de cuenta para un mes en curso"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "failed_to_generate"
                message: "Error al generar el estado de cuenta"

  /v1/bankstatements/generate-current:
    post:
      summary: Generar estado de cuenta del mes actual
      description: |
        Consume el endpoint `GET /v1/transactions/user/{iban}` del microservicio de transacciones,
        filtra las transacciones del mes en curso y genera un estado de cuenta persistido en MongoDB.
        
        **Características**:
        - Consume transacciones del microservicio externo
        - Filtra solo transacciones del mes actual
        - Calcula totales automáticamente
        - Persiste en MongoDB
        - Previene duplicados (verifica si ya existe)
        - Envía notificación al usuario
        
        **Autenticación requerida**: Este endpoint requiere un token JWT válido en el header Authorization.
      tags:
        - bankstatements
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - iban
              properties:
                iban:
                  type: string
                  pattern: '^ES[0-9]{22}$'
                  description: IBAN español (ES + 22 dígitos)
                  example: "ES1111111111111111111111"
      responses:
        '201':
          description: Estado de cuenta generado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Estado de cuenta generado exitosamente"
                  created:
                    type: boolean
                    example: true
                  statement:
                    $ref: '#/components/schemas/BankStatement'
              examples:
                success:
                  value:
                    message: "Estado de cuenta generado exitosamente"
                    created: true
                    statement:
                      _id: "677d3a9f1234567890abcdef"
                      account:
                        iban: "ES1111111111111111111111"
                        name: "Usuario"
                        email: "user@example.com"
                      date_start: "2026-01-01T00:00:00.000Z"
                      date_end: "2026-01-31T23:59:59.999Z"
                      year: 2026
                      month: 1
                      transactions: []
                      total_incoming: 1500.50
                      total_outgoing: 800.00
        '200':
          description: Estado de cuenta actualizado con las transacciones más recientes
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Estado de cuenta actualizado con las transacciones más recientes"
                  updated:
                    type: boolean
                    example: true
                  statement:
                    $ref: '#/components/schemas/BankStatement'
        '400':
          description: IBAN inválido o datos de entrada incorrectos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "invalid_iban"
                message: "El formato del IBAN es inválido"
        '403':
          description: Sin permiso para generar estados de cuenta para este IBAN
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "forbidden"
                message: "No tienes permiso para generar estados de cuenta para este IBAN"
        '404':
          description: No se encontraron transacciones para el mes actual
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "no_transactions_found"
                  message:
                    type: string
                    example: "No se encontraron transacciones para el mes actual"
        '502':
          description: Error al obtener transacciones del servicio externo
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "error_fetching_transactions"
                  message:
                    type: string
        '500':
          description: Error al generar el estado de cuenta
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    MonthSummary:
      type: object
      description: Resumen de estados de cuenta disponibles para un mes específico
      properties:
        year:
          type: integer
          example: 2025
        month:
          type: integer
          minimum: 1
          maximum: 12
          example: 1
        month_name:
          type: string
          example: "Enero"
        count:
          type: integer
          description: Número de statements para este mes
          example: 1
        Id:
          type: string
          description: ID representativo del statement de este mes
          example: "677d3a9f1234567890abcdef"
      required: [year, month, count]

    BankStatement:
      type: object
      description: Estado de cuenta bancario
      properties:
        _id:
          type: string
          description: ID de MongoDB
          example: "677d3a9f1234567890abcdef"
        account:
          type: object
          properties:
            iban:
              type: string
              pattern: '^ES[0-9]{22}$'
              example: "ES1111111111111111111111"
            name:
              type: string
              example: "Usuario"
            email:
              type: string
              format: email
              example: "user@example.com"
        date_start:
          type: string
          format: date-time
          description: Fecha de inicio del periodo
          example: "2026-01-01T00:00:00.000Z"
        date_end:
          type: string
          format: date-time
          description: Fecha de fin del periodo
          example: "2026-01-31T23:59:59.999Z"
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/Transaction'
        total_incoming:
          type: number
          description: Total de dinero recibido
          example: 1500.50
        total_outgoing:
          type: number
          description: Total de dinero enviado
          example: 800.00
        year:
          type: integer
          example: 2026
        month:
          type: integer
          minimum: 1
          maximum: 12
          example: 1
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [account, date_start, date_end, year, month, total_incoming, total_outgoing]

    Transaction:
      type: object
      description: Transacción bancaria
      properties:
        date:
          type: string
          format: date-time
          example: "2026-01-15T10:30:00.000Z"
        amount:
          type: number
          description: Monto de la transacción (positivo para ingresos, negativo para egresos)
          example: 250.50
        currency:
          type: string
          example: "EUR"
        description:
          type: string
          example: "Transferencia recibida"
      required: [date, amount, currency]

    Error:
      type: object
      properties:
        error:
          type: string
          example: "not_found"
        message:
          type: string
          example: "Recurso no encontrado"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtenido del API Gateway.
        
        Payload esperado:
        ```json
        {
          "id": "string",
          "name": "string",
          "email": "string",
          "iban": "string",
          "phoneNumber": "string",
          "subscription": "string"
        }
        ```

security:
  - bearerAuth: []

tags:
  - name: health
    description: Operaciones de salud del servicio
  - name: bankstatements
    description: Operaciones sobre estados de cuenta bancarios
